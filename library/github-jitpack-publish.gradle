/**
 * <b>How to use:</b>
 *
 * <pre>
 * - Step 1: apply file to build.gradle
 * apply from: './github-jitpack-publish.gradle'
 *
 * - Step 2: define groupId, artifactId and version
 * GithubJitPackPublish {
 *    it.userName = '{github-username}'
 *    it.repositoryName = '{repository-name}'
 *    it.version = '1.0.0'          // (optional)
 *    it.availableLibrary = null    // (optional null, aar, jar)
 *    it.release = true             // (optional)
 * }
 * </pre>
 * @author MCT-LIB
 */

class Config {
    public String userName
    public String repositoryName
    public String version = '1.0.0'
    public String availableLibrary = null
    public boolean release = true
}

ext.GithubJitPackPublish = { Closure<Config> configClosure ->
    if (configClosure == null) {
        return
    }
    // Prepare config
    Config config = new Config()
    configClosure.call(config)

    // Validate config
    Objects.requireNonNull(config, 'Config cannot be null!')
    Objects.requireNonNull(config.userName, 'Config invalid! Set your github username.')
    Objects.requireNonNull(config.repositoryName, 'Config invalid! Set your repository name.')
    Objects.requireNonNull(config.version, 'Config invalid! Set your version.')

    // Define configuration
    String _groupId = 'com.github.' + config.userName
    String _artifactId = config.repositoryName
    String _version = config.version
    String _availableLibrary = config.availableLibrary
    boolean _release = config.release

    // Add plugin maven-publish
    if (!getPlugins().hasPlugin('maven-publish')) {
        getPlugins().apply('maven-publish')
    }

    // Configure maven-publish
    publishing {
        publications {
            release(MavenPublication) {
                // define groupId, artifactId and version
                groupId = _groupId
                artifactId = _artifactId
                version = _version

                // define artifact file
                if (_availableLibrary != null) {
                    artifact('library.' + _availableLibrary)
                } else {
                    afterEvaluate {
                        artifact(tasks.named(_release ? 'bundleReleaseAar' : 'bundleDebugAar').get())
                    }
                }

                // Define this explicitly if using implementation or api configurations
                pom.withXml {
                    def root = asNode()

                    // ---------------------------
                    // DEPENDENCIES SECTION
                    // ---------------------------

                    def dependenciesNode = root['dependencies'][0] ?: root.appendNode('dependencies')

                    configurations.implementation.allDependencies.each {
                        if (it.name != 'unspecified') {
                            def dependencyNode = dependenciesNode.appendNode('dependency')
                            dependencyNode.appendNode('groupId', it.group)
                            dependencyNode.appendNode('artifactId', it.name)
                            dependencyNode.appendNode('version', it.version)
                        }
                    }

                    // ---------------------------
                    // BUILD / PLUGINS SECTION
                    // ---------------------------

                    if (_availableLibrary != null) {
                        def buildNode = root['build'][0] ?: root.appendNode('build')
                        def pluginsNode = buildNode['plugins'][0] ?: buildNode.appendNode('plugins')

                        def pluginNode = pluginsNode.appendNode('plugin')
                        pluginNode.appendNode('groupId', 'com.simpligility.maven.plugins')
                        pluginNode.appendNode('artifactId', 'android-maven-plugin')
                        pluginNode.appendNode('version', '4.1.0')
                        pluginNode.appendNode('extensions', 'true')

                        def configurationNode = pluginNode.appendNode('configuration')
                        def signNode = configurationNode.appendNode('sign')
                        signNode.appendNode('debug', 'false')
                    }
                }
            }
        }
    }
}
